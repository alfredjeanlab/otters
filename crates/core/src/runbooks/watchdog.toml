# Watchdog System Configuration
# Monitors agent health and triggers recovery actions when problems are detected.
#
# This configuration defines watchers that monitor for:
# - Idle sessions (agents that stop producing output)
# - Stuck tasks (tasks that miss heartbeats)
# - Queue backlogs (queues that grow too large)

[meta]
name = "watchdog"
description = "Agent health monitoring and recovery"
version = "1.0.0"

# ========================================
# Actions
# ========================================
# Actions are recovery operations with cooldowns to prevent rapid-fire triggers.

[action.nudge]
name = "Nudge idle agent"
cooldown = "30s"

[action.restart]
name = "Restart stuck agent"
cooldown = "5m"

[action.escalate]
name = "Escalate to human"
cooldown = "15m"

[action.scale-workers]
name = "Scale worker pool"
cooldown = "10m"

# ========================================
# Watchers
# ========================================
# Watchers monitor conditions and trigger response chains when thresholds are exceeded.

[watcher.session-idle]
name = "Monitor session idle time"
source = { type = "session", name = "{{session_name}}" }
condition = { type = "idle", threshold = "5m" }
check_interval = "60s"

[[watcher.session-idle.response]]
action = "nudge"

[[watcher.session-idle.response]]
action = "restart"
delay = "2m"
requires_previous_failure = true

[[watcher.session-idle.response]]
action = "escalate"
delay = "5m"
requires_previous_failure = true

[watcher.task-stuck]
name = "Monitor task heartbeat"
source = { type = "task", id = "{{task_id}}" }
condition = { type = "stuck_in_state", state = "stuck", threshold = "3m" }
check_interval = "30s"

[[watcher.task-stuck.response]]
action = "nudge"

[[watcher.task-stuck.response]]
action = "restart"
delay = "90s"
requires_previous_failure = true

[watcher.queue-depth]
name = "Monitor queue backlog"
source = { type = "queue", name = "merges" }
condition = { type = "exceeds", threshold = 100 }
check_interval = "2m"

[[watcher.queue-depth.response]]
action = "scale-workers"

[watcher.consecutive-failures]
name = "Monitor consecutive task failures"
source = { type = "events", pattern = "task:failed" }
condition = { type = "consecutive_failures", count = 3 }
check_interval = "1m"

[[watcher.consecutive-failures.response]]
action = "escalate"
