# Build Runbook
#
# Feature development: plan → decompose → execute → merge
# Command directly triggers pipeline.

# ------------------------------------------------------------------------------
# Command
# ------------------------------------------------------------------------------

[command.build]
args = "<name> <prompt> [-a/--after <dep>]"
run = { pipeline = "build" }

# ------------------------------------------------------------------------------
# Pipeline
# ------------------------------------------------------------------------------

[pipeline.build]
inputs = ["name", "prompt", "after"]

[pipeline.build.defaults]
branch = "feature/{name}"
after = ""

[[pipeline.build.phase]]
name = "init"
run = "wok new feature \"{prompt}\" -l plan:{name}"
next = "plan"

[[pipeline.build.phase]]
name = "blocked"
pre = ["blocker_merged"]
next = "plan"

[[pipeline.build.phase]]
name = "plan"
run = { agent = "planning" }
semaphore = "agents"
post = ["plan_exists"]
next = "decompose"

[[pipeline.build.phase]]
name = "decompose"
run = { agent = "decomposition" }
semaphore = "agents"
post = ["epic_created"]
next = "execute"

[[pipeline.build.phase]]
name = "execute"
run = { agent = "execution" }
semaphore = "agents"
post = ["issues_closed"]
next = "merge"
on_fail = "escalate"

[[pipeline.build.phase]]
name = "merge"
run = { strategy = "merge" }
lock = "main_branch"
next = "done"
on_fail = "escalate"

[[pipeline.build.phase]]
name = "done"
run = """
git push origin --delete {branch}
wok done {epic}
"""

# ------------------------------------------------------------------------------
# Agents
# ------------------------------------------------------------------------------

[agent.planning]
run = "claude --print"
prompt_file = "templates/plan.md"
env = { OJ_PIPELINE = "{name}", OJ_PHASE = "plan" }
cwd = "{workspace}"
heartbeat = "output"
timeout = "30m"
idle_timeout = "2m"
on_stuck = "restart"

[agent.decomposition]
run = "claude --print"
prompt_file = "templates/decompose.md"
env = { OJ_PIPELINE = "{name}", OJ_PHASE = "decompose" }
cwd = "{workspace}"
heartbeat = "output"
timeout = "15m"
idle_timeout = "2m"
on_stuck = "restart"

[agent.execution]
run = "claude --print"
prompt_file = "templates/execute.md"
env = { OJ_PIPELINE = "{name}", OJ_PHASE = "execute" }
cwd = "{workspace}"
heartbeat = "output"
timeout = "4h"
idle_timeout = "5m"
on_stuck = ["nudge", "restart"]
on_timeout = "escalate"

[agent.conflict_resolution]
run = "claude --print"
prompt_file = "templates/conflict.md"
env = { OJ_PIPELINE = "{name}", OJ_PHASE = "merge" }
heartbeat = "output"
timeout = "30m"

# ------------------------------------------------------------------------------
# Guards
# ------------------------------------------------------------------------------

[guard.blocker_merged]
condition = "test -z '{after}' || oj pipeline show {after} --phase | grep -q done"
wake_on = ["pipeline:{after}:complete"]

[guard.plan_exists]
condition = "test -f plans/{name}.md"
timeout = "30m"
on_timeout = "escalate"

[guard.epic_created]
condition = "grep -q 'epic:' plans/{name}.md"
timeout = "15m"
on_timeout = "escalate"

[guard.issues_closed]
condition = "wok list -l plan:{name} -s todo,in_progress --count | grep -q '^0$'"
retry = { max = 3, interval = "10s" }
timeout = "5m"
on_timeout = "escalate"

# ------------------------------------------------------------------------------
# Strategy
# ------------------------------------------------------------------------------

[strategy.merge]
checkpoint = "git rev-parse HEAD"
on_exhaust = "escalate"

[[strategy.merge.attempt]]
name = "fast-forward"
run = "git fetch origin main && git merge --ff-only origin/main"
timeout = "1m"

[[strategy.merge.attempt]]
name = "rebase"
run = "git rebase origin/main && git push"
timeout = "5m"
rollback = "git rebase --abort; git reset --hard {checkpoint}"

[[strategy.merge.attempt]]
name = "agent-resolve"
run = { agent = "conflict_resolution" }
timeout = "30m"
rollback = "git reset --hard {checkpoint}"

# ------------------------------------------------------------------------------
# Locks & Semaphores
# ------------------------------------------------------------------------------

[lock.main_branch]
timeout = "30m"
heartbeat = "30s"
on_stale = ["release", "rollback", "escalate"]

[semaphore.agents]
max = 4
slot_timeout = "4h"
slot_heartbeat = "1m"
on_orphan = "reclaim"

# ------------------------------------------------------------------------------
# Events
# ------------------------------------------------------------------------------

[pipeline.build.events]
on_phase = "oj emit pipeline:phase --id {name} --phase {phase}"
on_complete = "oj emit pipeline:complete --id {name}"
on_fail = "oj emit pipeline:fail --id {name} --error '{error}'"
