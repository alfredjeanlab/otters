# Build Runbook
#
# Feature development: plan → decompose → execute → merge
# Command queues work, worker processes it.

# ------------------------------------------------------------------------------
# Command
# ------------------------------------------------------------------------------

[command.build]
args = "<name> <prompt> [--priority <n>] [--after <op>]"
aliases = { p = "priority", a = "after" }
defaults = { priority = 2 }
run = """
oj queue add builds name={name} prompt={prompt} priority={priority} after={after}
oj worker wake builds
"""

# ------------------------------------------------------------------------------
# Worker
# ------------------------------------------------------------------------------

[worker.builds]
queue = "builds"
handler = "pipeline.build"
concurrency = 1
idle_action = "wait:30s"
wake_on = ["build:queued"]
on_unhealthy = "restart"

# ------------------------------------------------------------------------------
# Queue
# ------------------------------------------------------------------------------

[queue.builds]
order = "priority DESC, created_at ASC"
visibility_timeout = "4h"
max_retries = 1
on_exhaust = "escalate"

# ------------------------------------------------------------------------------
# Pipeline
# ------------------------------------------------------------------------------

[pipeline.build]
inputs = ["name", "prompt", "after"]

[pipeline.build.defaults]
workspace = ".worktrees/build-{name}"
branch = "build-{name}"

[[pipeline.build.phase]]
name = "init"
run = """
git worktree add {workspace} -b {branch}
wk new feature "{prompt}" -l plan:{name}
oj pipeline set-epic {name} $(wk list -l plan:{name} --type feature --json | jq -r '.[0].id')
"""
next = "plan"

[[pipeline.build.phase]]
name = "blocked"
pre = ["blocker_merged"]
next = "plan"

[[pipeline.build.phase]]
name = "plan"
task = "planning"
semaphore = "agents"
post = ["plan_exists"]
next = "decompose"

[[pipeline.build.phase]]
name = "decompose"
task = "decomposition"
semaphore = "agents"
post = ["epic_created"]
next = "execute"

[[pipeline.build.phase]]
name = "execute"
task = "execution"
semaphore = "agents"
post = ["issues_closed"]
next = "merge"
on_fail = "verify_and_retry"

[[pipeline.build.phase]]
name = "merge"
strategy = "merge"
lock = "main_branch"
next = "done"
on_fail = "escalate"

[[pipeline.build.phase]]
name = "done"
run = """
git worktree remove {workspace}
git push origin --delete {branch}
wk done {epic}
oj pipeline transition {name} merged
"""

# ------------------------------------------------------------------------------
# Tasks
# ------------------------------------------------------------------------------

[task.planning]
command = "claude --print"
prompt_file = "templates/plan.md"
env = { OTTER_PIPELINE = "{name}", OTTER_PHASE = "plan" }
cwd = "{workspace}"
heartbeat = "output"
timeout = "30m"
idle_timeout = "2m"
on_stuck = "restart"

[task.decomposition]
command = "claude --print"
prompt_file = "templates/decompose.md"
env = { OTTER_PIPELINE = "{name}", OTTER_PHASE = "decompose" }
cwd = "{workspace}"
heartbeat = "output"
timeout = "15m"
idle_timeout = "2m"
on_stuck = "restart"

[task.execution]
command = "claude --print"
prompt_file = "templates/execute.md"
env = { OTTER_PIPELINE = "{name}", OTTER_PHASE = "execute" }
cwd = "{workspace}"
heartbeat = "output"
timeout = "4h"
idle_timeout = "5m"
on_stuck = ["nudge", "restart"]
on_timeout = "checkpoint_and_escalate"
checkpoint_interval = "10m"
checkpoint = "wk note {epic} 'checkpoint: progress saved'"

[task.conflict_resolution]
command = "claude --print"
prompt_file = "templates/conflict.md"
env = { OTTER_PIPELINE = "{name}", OTTER_PHASE = "merge" }
heartbeat = "output"
timeout = "30m"

# ------------------------------------------------------------------------------
# Guards
# ------------------------------------------------------------------------------

[guard.blocker_merged]
condition = "test -z '{after}' || oj pipeline show {after} --phase | grep -q merged"
wake_on = ["pipeline:{after}:merged"]

[guard.plan_exists]
condition = "test -f plans/{name}.md"
timeout = "30m"
on_timeout = "escalate"

[guard.epic_created]
condition = "grep -q 'epic:' plans/{name}.md"
timeout = "15m"
on_timeout = "escalate"

[guard.issues_closed]
condition = "wk list -l plan:{name} -s todo,in_progress --count | grep -q '^0$'"
retry = { max = 3, interval = "10s" }
timeout = "5m"
on_timeout = "escalate"

# ------------------------------------------------------------------------------
# Strategy
# ------------------------------------------------------------------------------

[strategy.merge]
checkpoint = "git rev-parse HEAD"
on_exhaust = "escalate"

[[strategy.merge.attempt]]
name = "fast-forward"
run = "git fetch origin {branch} && git merge --ff-only FETCH_HEAD"
timeout = "1m"

[[strategy.merge.attempt]]
name = "rebase"
run = "git fetch origin {branch} && git rebase FETCH_HEAD && git push"
timeout = "5m"
rollback = "git rebase --abort; git reset --hard {checkpoint}"

[[strategy.merge.attempt]]
name = "agent-resolve"
task = "conflict_resolution"
timeout = "30m"
rollback = "git reset --hard {checkpoint}"

# ------------------------------------------------------------------------------
# Locks & Semaphores
# ------------------------------------------------------------------------------

[lock.main_branch]
timeout = "30m"
heartbeat = "30s"
on_stale = ["release", "rollback", "escalate"]

[lock.workspace]
timeout = "6h"
heartbeat = "1m"
on_stale = ["release", "cleanup"]

[semaphore.agents]
max = 4
slot_timeout = "4h"
slot_heartbeat = "1m"
on_orphan = "reclaim"
on_orphan_work = "requeue"

# ------------------------------------------------------------------------------
# Events
# ------------------------------------------------------------------------------

[events]
on_phase_change = "oj emit pipeline:phase --id {name} --phase {phase}"
on_complete = "oj emit pipeline:complete --id {name}"
on_fail = "oj emit pipeline:fail --id {name} --error '{error}'"
