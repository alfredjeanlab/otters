# Bugfix Runbook
#
# Quick bug fixing: pick bug → fix → verify → merge
# Command queues bug, worker processes it.

# ------------------------------------------------------------------------------
# Command
# ------------------------------------------------------------------------------

[command.bugfix]
args = "<bug_id>"
run = """
oj queue add bugs {bug_id}
oj worker wake bugfix
"""

# ------------------------------------------------------------------------------
# Worker
# ------------------------------------------------------------------------------

[worker.bugfix]
queue = "bugs"
handler = "pipeline.fix"
concurrency = 1
idle_action = "wait:30s"
wake_on = ["bug:created", "bug:prioritized"]
on_unhealthy = "restart"

# ------------------------------------------------------------------------------
# Queue
# ------------------------------------------------------------------------------

[queue.bugs]
source = "wk list -l bug -s todo --json"
filter = "not has_label('assigned')"
order = "priority"
visibility_timeout = "30m"
max_retries = 2
on_exhaust = "dead"

[queue.bugs.dead]
retention = "7d"
on_add = "oj emit queue:dead --queue bugs --id {id} --reason '{reason}'"

# ------------------------------------------------------------------------------
# Pipeline
# ------------------------------------------------------------------------------

[pipeline.fix]
inputs = ["bug"]

[pipeline.fix.defaults]
workspace = ".worktrees/bugfix-{bug.id}"
branch = "fix/{bug.id}"

[[pipeline.fix.phase]]
name = "setup"
run = """
git worktree add {workspace} -b {branch}
wk start {bug.id}
wk label {bug.id} assigned
"""
next = "fix"

[[pipeline.fix.phase]]
name = "fix"
task = "fix_task"
semaphore = "agents"
next = "verify"
on_fail = "escalate"

[[pipeline.fix.phase]]
name = "verify"
run = "cd {workspace} && make test"
next = "merge"
on_fail = "fix"  # Loop back

[[pipeline.fix.phase]]
name = "merge"
strategy = "merge"
lock = "main_branch"
next = "cleanup"
on_fail = "escalate"

[[pipeline.fix.phase]]
name = "cleanup"
run = """
git worktree remove {workspace}
git push origin --delete {branch}
wk done {bug.id}
"""

# ------------------------------------------------------------------------------
# Tasks
# ------------------------------------------------------------------------------

[task.fix_task]
command = "claude --print"
prompt = """
Fix the bug described in issue {bug.id}:

{bug.description}

The code is in: {workspace}

When done:
1. Commit your changes
2. Run tests to verify
3. Signal completion with: oj done
"""
env = { OTTER_PIPELINE = "bugfix-{bug.id}", OTTER_PHASE = "fix" }
cwd = "{workspace}"
heartbeat = "output"
timeout = "1h"
idle_timeout = "3m"
on_stuck = ["nudge", "restart"]
on_timeout = "escalate"

# ------------------------------------------------------------------------------
# Strategy
# ------------------------------------------------------------------------------

[strategy.merge]
checkpoint = "git rev-parse HEAD"
on_exhaust = "escalate"

[[strategy.merge.attempt]]
name = "fast-forward"
run = "git fetch origin && git merge --ff-only origin/main"
timeout = "1m"

[[strategy.merge.attempt]]
name = "rebase"
run = "git rebase origin/main && git push"
timeout = "5m"
rollback = "git rebase --abort; git reset --hard {checkpoint}"

# ------------------------------------------------------------------------------
# Locks & Semaphores
# ------------------------------------------------------------------------------

[lock.main_branch]
timeout = "30m"
heartbeat = "30s"
on_stale = ["release", "rollback", "escalate"]

[semaphore.agents]
max = 4
slot_timeout = "2h"
slot_heartbeat = "1m"
on_orphan = "reclaim"
on_orphan_work = "requeue"

# ------------------------------------------------------------------------------
# Events
# ------------------------------------------------------------------------------

[events]
on_fix_complete = "oj emit bugfix:complete --bug {bug.id}"
on_fix_fail = "oj emit bugfix:fail --bug {bug.id} --error '{error}'"
