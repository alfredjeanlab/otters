# Triager Runbook
#
# Handles failed operations and escalations.
# Analyzes failures and decides: retry, reassign, or escalate.

# ------------------------------------------------------------------------------
# Cron
# ------------------------------------------------------------------------------

[cron.triager]
interval = "1m"
watchers = ["failed_operations", "repeat_failures", "dead", "stale_escalations"]
on_error = "log_and_continue"

# ------------------------------------------------------------------------------
# Watchers
# ------------------------------------------------------------------------------

# Failed operations
[watcher.failed_operations]
source = "oj pipeline list --phase failed --json"
response = ["analyze", "decide"]

# Repeated failures
[watcher.repeat_failures]
source = "oj pipeline list --json"
condition = "oj pipeline failure-count {name} >= 3"
response = ["mark_flaky", "escalate"]

# Dead letter items
[watcher.dead]
source = "oj queue dead --json"
condition = "age(created_at) < '1h'"
response = ["analyze", "decide_requeue"]

# Stale escalations (no response in 4h)
[watcher.stale_escalations]
source = "oj escalation list --status open --json"
condition = "age(created_at) > '4h'"
response = ["re_escalate"]

# ------------------------------------------------------------------------------
# Analysis
# ------------------------------------------------------------------------------

[action.analyze]
run = """
error=$(oj pipeline error {name})
case "$error" in
    *"rate limit"*) echo "rate_limited" ;;
    *"context length"*) echo "context_exhausted" ;;
    *"merge conflict"*) echo "merge_conflict" ;;
    *"test failed"*) echo "test_failure" ;;
    *) echo "unknown" ;;
esac
"""
output = "analysis"

# ------------------------------------------------------------------------------
# Decision Rules
# ------------------------------------------------------------------------------

[action.decide]
rules = [
    { if = "analysis == 'rate_limited'", then = "wait_retry", delay = "5m" },
    { if = "analysis == 'context_exhausted'", then = "restart_fresh" },
    { if = "analysis == 'merge_conflict'", then = "escalate" },
    { if = "analysis == 'test_failure' && failure_count < 2", then = "retry" },
    { if = "analysis == 'test_failure'", then = "escalate" },
    { if = "failure_count < 1", then = "retry" },
    { else = "escalate" }
]

[action.decide_requeue]
rules = [
    { if = "attempts < 5 && error_type == 'transient'", then = "requeue" },
    { else = "abandon" }
]

# ------------------------------------------------------------------------------
# Recovery Actions
# ------------------------------------------------------------------------------

[action.retry]
max = 2
run = "oj pipeline resume {name}"
cooldown = "5m"

[action.wait_retry]
run = """
sleep {delay}
oj pipeline resume {name}
"""

[action.restart_fresh]
run = """
oj session kill {session}
oj pipeline checkpoint restore {name}
oj pipeline resume {name} --fresh
"""

[action.requeue]
run = "oj queue requeue {queue} {id}"

[action.abandon]
run = "oj queue abandon {queue} {id}"

[action.mark_flaky]
run = """
oj pipeline label {name} flaky
wk label {epic} flaky
"""

# ------------------------------------------------------------------------------
# Escalation Actions
# ------------------------------------------------------------------------------

[action.escalate]
run = """
oj escalation create {name} --reason "{analysis}"
wk new bug "Operation {name} needs intervention" \
    --note "Phase: {phase}\nError: {analysis}\nRetries: {failure_count}" \
    -l escalation,needs-review
oj emit triager:escalate --id {name} --reason "{analysis}"
"""

[action.re_escalate]
run = """
oj escalation bump {id}
oj emit triager:re-escalate --id {id} --age "{age}"
"""

# ------------------------------------------------------------------------------
# Events
# ------------------------------------------------------------------------------

[events]
on_retry = "oj emit triager:retry --id {name}"
on_escalate = "oj emit triager:escalate --id {name} --reason '{reason}'"
on_abandon = "oj emit triager:abandon --queue {queue} --id {id}"
