# Loop Runbook
#
# Continuous issue resolution worker.
# Picks issues from queue, resolves them, repeats.

# ------------------------------------------------------------------------------
# Worker
# ------------------------------------------------------------------------------

[worker.loop]
queue = "issues"
handler = "task.resolve_issue"
concurrency = 1
idle_action = "wait:30s"
wake_on = ["issue:created", "issue:unblocked"]
on_unhealthy = "restart"

# ------------------------------------------------------------------------------
# Config
# ------------------------------------------------------------------------------

[config]
labels = []              # Filter by labels, e.g. ["mod:cli", "priority:1"]
dir_filter = ""          # Only issues affecting this directory
safe = false             # Require permission prompts

# ------------------------------------------------------------------------------
# Queue
# ------------------------------------------------------------------------------

[queue.issues]
source = "wk ready --json"
filter = """
('{config.labels}' == '' || has_any_label({config.labels})) &&
('{config.dir_filter}' == '' || affects_dir('{config.dir_filter}'))
"""
order = "priority"
visibility_timeout = "2h"
max_retries = 2
on_exhaust = "wait"

[queue.issues.dead]
retention = "7d"
on_add = "oj emit queue:dead --queue issues --id {id} --reason '{reason}'"

# ------------------------------------------------------------------------------
# Task
# ------------------------------------------------------------------------------

[task.resolve_issue]
command = "claude --print"
prompt = """
Resolve the following issue:

Issue ID: {issue.id}
Type: {issue.type}
Title: {issue.title}

Description:
{issue.description}

Work in the main repository. When done:
1. Commit your changes with a descriptive message
2. Close the issue with: wk done {issue.id}
3. Signal completion with: oj done

If you cannot complete the issue, signal with: oj done --error "reason"
"""
env = { OTTER_PIPELINE = "loop-{issue.id}", OTTER_PHASE = "resolve", OTTER_SAFE = "{config.safe}" }
cwd = "."
heartbeat = "output"
timeout = "2h"
idle_timeout = "5m"
on_stuck = ["nudge", "restart"]
on_timeout = "requeue"

# Checkpoint to issue notes
checkpoint_interval = "10m"
checkpoint = "wk note {issue.id} 'progress: still working'"

# ------------------------------------------------------------------------------
# Semaphore
# ------------------------------------------------------------------------------

[semaphore.agents]
max = 4
slot_timeout = "2h"
slot_heartbeat = "1m"
on_orphan = "reclaim"
on_orphan_work = "requeue"

# ------------------------------------------------------------------------------
# Functions
# ------------------------------------------------------------------------------

[functions]
# Check if issue has any of the specified labels
has_any_label = "wk show {id} --json | jq -e '.labels | any(. as $l | {labels} | any(. == $l))'"

# Check if issue affects a specific directory
affects_dir = "wk show {id} --json | jq -e '.labels | any(startswith(\"mod:\"))'"

# Get issue age
issue_age = "wk show {id} --json | jq -r '.created_at' | xargs -I{} date -d {} +%s"

# ------------------------------------------------------------------------------
# Events
# ------------------------------------------------------------------------------

[events]
on_issue_start = "oj emit loop:start --issue {issue.id}"
on_issue_complete = """
wk done {issue.id}
oj emit loop:complete --issue {issue.id}
"""
on_issue_fail = """
wk note {issue.id} "Failed: {error}"
wk label {issue.id} needs-review
oj emit loop:fail --issue {issue.id} --error "{error}"
"""
on_issue_requeue = """
wk note {issue.id} "Requeued: {reason}"
oj emit loop:requeue --issue {issue.id} --reason "{reason}"
"""
