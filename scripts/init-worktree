#!/usr/bin/env bash
# SPDX-License-Identifier: BUSL-1.1
# Copyright (c) 2026 Alfred Jean LLC
#
# Initialize a new worktree with required dependencies.
# Used with V0_WORKTREE_INIT hook to copy cached libraries.
#
# Environment:
#   V0_CHECKOUT_DIR - Path to main checkout
#   V0_WORKTREE_DIR - Path to new worktree

set -euo pipefail

: "${V0_CHECKOUT_DIR:?V0_CHECKOUT_DIR must be set}"
: "${V0_WORKTREE_DIR:?V0_WORKTREE_DIR must be set}"

BATS_LIBS=("bats-core" "bats-support" "bats-assert")
SRC_BATS_DIR="$V0_CHECKOUT_DIR/tests/specs/bats"
DST_BATS_DIR="$V0_WORKTREE_DIR/tests/specs/bats"

# Ensure bats libraries exist in main checkout
install_to_checkout() {
    local install_script="$V0_CHECKOUT_DIR/tests/specs/bats/install.sh"
    if [[ -x "$install_script" ]]; then
        echo "Installing BATS to main checkout..."
        "$install_script"
    else
        echo "Warning: install.sh not found at $install_script" >&2
    fi
}

# Copy bats libraries to worktree
copy_to_worktree() {
    mkdir -p "$DST_BATS_DIR"

    for lib in "${BATS_LIBS[@]}"; do
        local src="$SRC_BATS_DIR/$lib"
        local dst="$DST_BATS_DIR/$lib"

        if [[ -d "$src" ]] && [[ ! -d "$dst" ]]; then
            echo "Copying $lib to worktree..."
            cp -r "$src" "$dst"
        fi
    done
}

main() {
    # Check if any bats lib is missing from main checkout
    local need_install=false
    for lib in "${BATS_LIBS[@]}"; do
        if [[ ! -d "$SRC_BATS_DIR/$lib" ]]; then
            need_install=true
            break
        fi
    done

    if $need_install; then
        install_to_checkout
    fi

    copy_to_worktree
    echo "Worktree initialized"
}

main "$@"
