#!/usr/bin/env bash
# SPDX-License-Identifier: BUSL-1.1
# Copyright (c) 2026 Alfred Jean LLC
#
# Run BATS specs
#
# Usage: scripts/spec [options] [file...]
#
# Options:
#   --filter <regex>   Filter tests by name
#   --timeout <secs>   Test timeout (default: 5)
#   --parallel         Run tests in parallel (auto-calculated jobs)
#   --jobs <n>         Run with N parallel jobs
#
# Examples:
#   scripts/spec                           # Run all specs
#   scripts/spec tests/specs/unit/*.bats   # Run specific files
#   scripts/spec --filter "help"           # Filter by name

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SPECS_DIR="$PROJECT_ROOT/tests/specs"
BATS_DIR="$SPECS_DIR/bats"
BATS_BIN="$BATS_DIR/bats-core/bin/bats"

# Defaults
TIMEOUT=5
FILTER=""
PARALLEL=""
JOBS=""
FILES=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --filter)
            FILTER="$2"
            shift 2
            ;;
        --timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        --parallel)
            PARALLEL=1
            shift
            ;;
        --jobs)
            JOBS="$2"
            shift 2
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            FILES+=("$1")
            shift
            ;;
    esac
done

# Install bats if needed
install_bats() {
    if [[ ! -x "$BATS_BIN" ]]; then
        echo "Installing BATS..."
        "$BATS_DIR/install.sh"
    fi
}

# Build binaries
build_binaries() {
    echo "Building binaries..."
    cargo build -p oj --manifest-path "$PROJECT_ROOT/Cargo.toml" --quiet
}

# Calculate parallel jobs (80% of CPUs)
calculate_jobs() {
    local cpus
    if [[ "$(uname)" == "Darwin" ]]; then
        cpus=$(sysctl -n hw.ncpu)
    else
        cpus=$(nproc)
    fi
    echo $(( (cpus * 80) / 100 ))
}

main() {
    install_bats
    build_binaries

    # Set BATS_LIB_PATH for library loading
    export BATS_LIB_PATH="$BATS_DIR"

    # Set test timeout via environment variable
    export BATS_TEST_TIMEOUT="$TIMEOUT"

    # Build bats command
    local bats_args=()
    bats_args+=(--timing)
    bats_args+=(--print-output-on-failure)

    # Apply filter
    if [[ -n "$FILTER" ]]; then
        bats_args+=(--filter "$FILTER")
    fi

    # Apply parallelism
    if [[ -n "$PARALLEL" ]] || [[ -n "$JOBS" ]]; then
        local num_jobs="${JOBS:-$(calculate_jobs)}"
        if [[ "$num_jobs" -gt 1 ]]; then
            bats_args+=(--jobs "$num_jobs")
        fi
    fi

    # Determine files to run
    if [[ ${#FILES[@]} -eq 0 ]]; then
        # Run all specs recursively (excluding bats library directory)
        bats_args+=(--recursive)
        bats_args+=("$SPECS_DIR/unit")
        bats_args+=("$SPECS_DIR/integration")
        bats_args+=("$SPECS_DIR/edge_cases")
    else
        bats_args+=("${FILES[@]}")
    fi

    echo "Running specs..."
    echo ""
    "$BATS_BIN" "${bats_args[@]}"
}

main "$@"
