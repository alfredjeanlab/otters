#!/usr/bin/env bash
# scripts/lint - Policy lint checks for otters

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

failed=0

echo "Running policy checks..."
echo ""

# 1. Dead code check
echo "Checking for unauthorized dead code..."
DEAD_CODE=$(grep -r '#\[allow(dead_code)\]' crates/ --include="*.rs" | grep -v "// JUSTIFIED:" || true)
if [[ -n "$DEAD_CODE" ]]; then
    echo -e "${YELLOW}Found #[allow(dead_code)] without justification:${NC}"
    echo "$DEAD_CODE"
    failed=1
else
    echo -e "${GREEN}No unauthorized dead code${NC}"
fi

# 2. Unsafe check
echo ""
echo "Checking unsafe blocks..."
UNSAFE=$(grep -rn 'unsafe {' crates/ --include="*.rs" | grep -v "// SAFETY:" || true)
if [[ -n "$UNSAFE" ]]; then
    echo -e "${YELLOW}Found unsafe blocks without SAFETY comment:${NC}"
    echo "$UNSAFE"
    failed=1
else
    echo -e "${GREEN}All unsafe blocks documented${NC}"
fi

# 3. Test file conventions
echo ""
echo "Verifying test file conventions..."
while IFS= read -r -d '' test_file; do
    module_name=$(basename "$test_file" .rs)
    parent_dir=$(dirname "$test_file")
    mod_file="$parent_dir/mod.rs"

    if [[ -f "$mod_file" ]]; then
        if ! grep -q "#\[cfg(test)\]" "$mod_file" || ! grep -q "mod $module_name" "$mod_file"; then
            echo -e "${YELLOW}$test_file may not be imported correctly${NC}"
        fi
    fi
done < <(find crates/ -name "*_tests.rs" -print0)
echo -e "${GREEN}Test conventions OK${NC}"

# Summary
echo ""
if [[ $failed -eq 0 ]]; then
    echo -e "${GREEN}All policy checks passed${NC}"
    exit 0
else
    echo -e "${RED}Some policy checks failed${NC}"
    exit 1
fi
